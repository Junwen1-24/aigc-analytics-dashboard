import"./transform-oW_9wQLA.js";import{m as V}from"./mapbox-gl-BKwbCUZc.js";import{_ as rt,r as F,i as lt,w as Z,o as ut,a as gt,c as k,d as m,F as ct,f as dt,j as pt,t as K,e as H,g as mt}from"./index-BlnXBglW.js";import{e as B}from"./extent-Ccx1MofX.js";import{L as ot,P as ht,f as It,d as Ct,_,c as At,b as xt,A as it,i as ft,p as bt,M as yt,G as Tt,h as Q,F as P,l as X,C as j,T as U,g as vt,e as Y,B as $,w as wt,a as Mt}from"./mapbox-overlay-2WIKvrwx.js";import{c as St}from"./dsv-XhNTmijJ.js";const _t="compositeLayer.renderLayers";class st extends ot{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(t=>t.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(t){}setState(t){super.setState(t),this.setNeedsUpdate()}getPickingInfo({info:t}){const{object:e}=t;return e&&e.__source&&e.__source.parent&&e.__source.parent.id===this.id&&(t.object=e.__source.object,t.index=e.__source.index),t}filterSubLayer(t){return!0}shouldRenderSubLayer(t,e){return e&&e.length}getSubLayerClass(t,e){const{_subLayerProps:o}=this.props;return o&&o[t]&&o[t].type||e}getSubLayerRow(t,e,o){return t.__source={parent:this,object:e,index:o},t}getSubLayerAccessor(t){if(typeof t=="function"){const e={index:-1,data:this.props.data,target:[]};return(o,i)=>o&&o.__source?(e.index=o.__source.index,t(o.__source.object,e)):t(o,i)}return t}getSubLayerProps(t={}){var e;const{opacity:o,pickable:i,visible:s,parameters:n,getPolygonOffset:a,highlightedObjectIndex:r,autoHighlight:d,highlightColor:h,coordinateSystem:I,coordinateOrigin:c,wrapLongitude:A,positionFormat:f,modelMatrix:y,extensions:E,fetch:D,operation:R,_subLayerProps:M}=this.props,S={id:"",updateTriggers:{},opacity:o,pickable:i,visible:s,parameters:n,getPolygonOffset:a,highlightedObjectIndex:r,autoHighlight:d,highlightColor:h,coordinateSystem:I,coordinateOrigin:c,wrapLongitude:A,positionFormat:f,modelMatrix:y,extensions:E,fetch:D,operation:R},g=M&&t.id&&M[t.id],p=g&&g.updateTriggers,C=t.id||"sublayer";if(g){const x=this.props[ht],b=t.type?t.type._propTypes:{};for(const T in g){const v=b[T]||x[T];v&&v.type==="accessor"&&(g[T]=this.getSubLayerAccessor(g[T]))}}Object.assign(S,t,g),S.id="".concat(this.props.id,"-").concat(C),S.updateTriggers={all:(e=this.props.updateTriggers)===null||e===void 0?void 0:e.all,...t.updateTriggers,...p};for(const x of E){const b=x.getSubLayerProps.call(this,x);b&&Object.assign(S,b,{updateTriggers:Object.assign(S.updateTriggers,b.updateTriggers)})}return S}_updateAutoHighlight(t){for(const e of this.getSubLayers())e.updateAutoHighlight(t)}_getAttributeManager(){return null}_postUpdate(t,e){let o=this.internalState.subLayers;const i=!o||this.needsUpdate();if(i){const s=this.renderLayers();o=It(s,Boolean),this.internalState.subLayers=o}Ct(_t,this,i,o);for(const s of o)s.parent=this}}_(st,"layerName","CompositeLayer");const Lt=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function Ot(l,t=!1,e=Float32Array){let o;if(Number.isFinite(l[0]))o=new e(l);else{o=new e(l.length*4);let i=0;for(let s=0;s<l.length;s++){const n=l[s];o[i++]=n[0],o[i++]=n[1],o[i++]=n[2],o[i++]=Number.isFinite(n[3])?n[3]:255}}if(t)for(let i=0;i<o.length;i++)o[i]/=255;return o}function Nt(l,t){const e={};for(const o in l)t.includes(o)||(e[o]=l[o]);return e}class nt extends st{constructor(...t){super(...t),_(this,"state",void 0)}initializeAggregationLayer(t){super.initializeState(this.context),this.setState({ignoreProps:Nt(this.constructor._propTypes,t.data.props),dimensions:t})}updateState(t){super.updateState(t);const{changeFlags:e}=t;if(e.extensionsChanged){const o=this.getShaders({});o&&o.defines&&(o.defines.NON_INSTANCED_MODEL=1),this.updateShaders(o)}this._updateAttributes()}updateAttributes(t){this.setState({changedAttributes:t})}getAttributes(){return this.getAttributeManager().getShaderAttributes()}getModuleSettings(){const{viewport:t,mousePosition:e,gl:o}=this.context;return Object.assign(Object.create(this.props),{viewport:t,mousePosition:e,pickingActive:0,devicePixelRatio:At(o)})}updateShaders(t){}isAggregationDirty(t,e={}){const{props:o,oldProps:i,changeFlags:s}=t,{compareAll:n=!1,dimension:a}=e,{ignoreProps:r}=this.state,{props:d,accessors:h=[]}=a,{updateTriggersChanged:I}=s;if(s.dataChanged)return!0;if(I){if(I.all)return!0;for(const c of h)if(I[c])return!0}if(n)return s.extensionsChanged?!0:xt({oldProps:i,newProps:o,ignoreProps:r,propTypes:this.constructor._propTypes});for(const c of d)if(o[c]!==i[c])return!0;return!1}isAttributeChanged(t){const{changedAttributes:e}=this.state;return t?e&&e[t]!==void 0:!Et(e)}_getAttributeManager(){return new it(this.context.gl,{id:this.props.id,stats:this.context.stats})}}_(nt,"layerName","AggregationLayer");function Et(l){let t=!0;for(const e in l){t=!1;break}return t}function zt(l){const t=l.map(a=>a[0]),e=l.map(a=>a[1]),o=Math.min.apply(null,t),i=Math.max.apply(null,t),s=Math.min.apply(null,e),n=Math.max.apply(null,e);return[o,s,i,n]}function Wt(l,t){return t[0]>=l[0]&&t[2]<=l[2]&&t[1]>=l[1]&&t[3]<=l[3]}const q=new Float32Array(12);function tt(l,t=2){let e=0;for(const o of l)for(let i=0;i<t;i++)q[e++]=o[i]||0;return q}function jt(l,t,e){const[o,i,s,n]=l,a=s-o,r=n-i;let d=a,h=r;a/r<t/e?d=t/e*r:h=e/t*a,d<t&&(d=t,h=e);const I=(s+o)/2,c=(n+i)/2;return[I-d/2,c-h/2,I+d/2,c+h/2]}function Pt(l,t){const[e,o,i,s]=t;return[(l[0]-e)/(i-e),(l[1]-o)/(s-o)]}function Dt({gl:l,floatTargetSupport:t}){return t?{format:ft(l)?34836:6408,type:5126}:{format:6408,type:5121}}const Rt=`#define SHADER_NAME heatp-map-layer-vertex-shader

uniform sampler2D maxTexture;
uniform float intensity;
uniform vec2 colorDomain;
uniform float threshold;
uniform float aggregationMode;

attribute vec3 positions;
attribute vec2 texCoords;

varying vec2 vTexCoords;
varying float vIntensityMin;
varying float vIntensityMax;

void main(void) {
  gl_Position = project_position_to_clipspace(positions, vec3(0.0), vec3(0.0));
  vTexCoords = texCoords;
  vec4 maxTexture = texture2D(maxTexture, vec2(0.5));
  float maxValue = aggregationMode < 0.5 ? maxTexture.r : maxTexture.g;
  float minValue = maxValue * threshold;
  if (colorDomain[1] > 0.) {
    maxValue = colorDomain[1];
    minValue = colorDomain[0];
  }
  vIntensityMax = intensity / maxValue;
  vIntensityMin = intensity / minValue;
}
`,Ft=`#define SHADER_NAME triangle-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D texture;
uniform sampler2D colorTexture;
uniform float aggregationMode;

varying vec2 vTexCoords;
varying float vIntensityMin;
varying float vIntensityMax;

vec4 getLinearColor(float value) {
  float factor = clamp(value * vIntensityMax, 0., 1.);
  vec4 color = texture2D(colorTexture, vec2(factor, 0.5));
  color.a *= min(value * vIntensityMin, 1.0);
  return color;
}

void main(void) {
  vec4 weights = texture2D(texture, vTexCoords);
  float weight = weights.r;

  if (aggregationMode > 0.5) {
    weight /= max(1.0, weights.a);
  }
  if (weight <= 0.) {
     discard;
  }

  vec4 linearColor = getLinearColor(weight);
  linearColor.a *= opacity;
  gl_FragColor =linearColor;
}
`;class at extends ot{getShaders(){return{vs:Rt,fs:Ft,modules:[bt]}}initializeState({gl:t}){this.getAttributeManager().add({positions:{size:3,noAlloc:!0},texCoords:{size:2,noAlloc:!0}}),this.setState({model:this._getModel(t)})}_getModel(t){const{vertexCount:e}=this.props;return new yt(t,{...this.getShaders(),id:this.props.id,geometry:new Tt({drawMode:6,vertexCount:e})})}draw({uniforms:t}){const{model:e}=this.state,{texture:o,maxTexture:i,colorTexture:s,intensity:n,threshold:a,aggregationMode:r,colorDomain:d}=this.props;e.setUniforms({...t,texture:o,maxTexture:i,colorTexture:s,intensity:n,threshold:a,aggregationMode:r,colorDomain:d}).draw()}}_(at,"layerName","TriangleLayer");const Bt=`attribute vec3 positions;
attribute vec3 positions64Low;
attribute float weights;
varying vec4 weightsTexture;
uniform float radiusPixels;
uniform float textureWidth;
uniform vec4 commonBounds;
uniform float weightsScale;
void main()
{
  weightsTexture = vec4(weights * weightsScale, 0., 0., 1.);

  float radiusTexels  = project_pixel_size(radiusPixels) * textureWidth / (commonBounds.z - commonBounds.x);
  gl_PointSize = radiusTexels * 2.;

  vec3 commonPosition = project_position(positions, positions64Low);
  gl_Position.xy = (commonPosition.xy - commonBounds.xy) / (commonBounds.zw - commonBounds.xy) ;
  gl_Position.xy = (gl_Position.xy * 2.) - (1.);
}
`,Ut=`varying vec4 weightsTexture;
float gaussianKDE(float u){
  return pow(2.71828, -u*u/0.05555)/(1.77245385*0.166666);
}
void main()
{
  float dist = length(gl_PointCoord - vec2(0.5, 0.5));
  if (dist > 0.5) {
    discard;
  }
  gl_FragColor = weightsTexture * gaussianKDE(2. * dist);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Gt=`attribute vec4 inTexture;
varying vec4 outTexture;

void main()
{
outTexture = inTexture;
gl_Position = vec4(0, 0, 0, 1.);
gl_PointSize = 1.0;
}
`,kt=`varying vec4 outTexture;
void main() {
  gl_FragColor = outTexture;
  gl_FragColor.g = outTexture.r / max(1.0, outTexture.a);
}
`,Ht=2,G={mipmaps:!1,parameters:{10240:9729,10241:9729,10242:33071,10243:33071},dataFormat:6408},et=[0,0],Jt={SUM:0,MEAN:1},Vt={getPosition:{type:"accessor",value:l=>l.position},getWeight:{type:"accessor",value:1},intensity:{type:"number",min:0,value:1},radiusPixels:{type:"number",min:1,max:100,value:50},colorRange:Lt,threshold:{type:"number",min:0,max:1,value:.05},colorDomain:{type:"array",value:null,optional:!0},aggregation:"SUM",weightsTextureSize:{type:"number",min:128,max:2048,value:2048},debounceTimeout:{type:"number",min:0,max:1e3,value:500}},Zt=[P.BLEND_EQUATION_MINMAX,P.TEXTURE_FLOAT],Kt=[P.COLOR_ATTACHMENT_RGBA32F,P.FLOAT_BLEND],Qt={data:{props:["radiusPixels"]}};class J extends nt{constructor(...t){super(...t),_(this,"state",void 0)}initializeState(){const{gl:t}=this.context;if(!Q(t,Zt)){this.setState({supported:!1}),X.error("HeatmapLayer: ".concat(this.id," is not supported on this browser"))();return}super.initializeAggregationLayer(Qt),this.setState({supported:!0,colorDomain:et}),this._setupTextureParams(),this._setupAttributes(),this._setupResources()}shouldUpdateState({changeFlags:t}){return t.somethingChanged}updateState(t){this.state.supported&&(super.updateState(t),this._updateHeatmapState(t))}_updateHeatmapState(t){const{props:e,oldProps:o}=t,i=this._getChangeFlags(t);(i.dataChanged||i.viewportChanged)&&(i.boundsChanged=this._updateBounds(i.dataChanged),this._updateTextureRenderingBounds()),i.dataChanged||i.boundsChanged?(clearTimeout(this.state.updateTimer),this.setState({isWeightMapDirty:!0})):i.viewportZoomChanged&&this._debouncedUpdateWeightmap(),e.colorRange!==o.colorRange&&this._updateColorTexture(t),this.state.isWeightMapDirty&&this._updateWeightmap(),this.setState({zoom:t.context.viewport.zoom})}renderLayers(){if(!this.state.supported)return[];const{weightsTexture:t,triPositionBuffer:e,triTexCoordBuffer:o,maxWeightsTexture:i,colorTexture:s,colorDomain:n}=this.state,{updateTriggers:a,intensity:r,threshold:d,aggregation:h}=this.props,I=this.getSubLayerClass("triangle",at);return new I(this.getSubLayerProps({id:"triangle-layer",updateTriggers:a}),{coordinateSystem:j.DEFAULT,data:{attributes:{positions:e,texCoords:o}},vertexCount:4,maxTexture:i,colorTexture:s,aggregationMode:Jt[h]||0,texture:t,intensity:r,threshold:d,colorDomain:n})}finalizeState(t){super.finalizeState(t);const{weightsTransform:e,weightsTexture:o,maxWeightTransform:i,maxWeightsTexture:s,triPositionBuffer:n,triTexCoordBuffer:a,colorTexture:r,updateTimer:d}=this.state;e==null||e.delete(),o==null||o.delete(),i==null||i.delete(),s==null||s.delete(),n==null||n.delete(),a==null||a.delete(),r==null||r.delete(),d&&clearTimeout(d)}_getAttributeManager(){return new it(this.context.gl,{id:this.props.id,stats:this.context.stats})}_getChangeFlags(t){const e={},{dimensions:o}=this.state;e.dataChanged=this.isAttributeChanged()||this.isAggregationDirty(t,{compareAll:!0,dimension:o.data}),e.viewportChanged=t.changeFlags.viewportChanged;const{zoom:i}=this.state;return(!t.context.viewport||t.context.viewport.zoom!==i)&&(e.viewportZoomChanged=!0),e}_createTextures(){const{gl:t}=this.context,{textureSize:e,format:o,type:i}=this.state;this.setState({weightsTexture:new U(t,{width:e,height:e,format:o,type:i,...G}),maxWeightsTexture:new U(t,{format:o,type:i,...G})})}_setupAttributes(){this.getAttributeManager().add({positions:{size:3,type:5130,accessor:"getPosition"},weights:{size:1,accessor:"getWeight"}}),this.setState({positionAttributeName:"positions"})}_setupTextureParams(){const{gl:t}=this.context,{weightsTextureSize:e}=this.props,o=Math.min(e,vt(t,3379)),i=Q(t,Kt),{format:s,type:n}=Dt({gl:t,floatTargetSupport:i}),a=i?1:1/255;this.setState({textureSize:o,format:s,type:n,weightsScale:a}),i||X.warn("HeatmapLayer: ".concat(this.id," rendering to float texture not supported, fallingback to low precession format"))()}getShaders(t){return super.getShaders(t==="max-weights-transform"?{vs:Gt,_fs:kt}:{vs:Bt,_fs:Ut})}_createWeightsTransform(t={}){var e;const{gl:o}=this.context;let{weightsTransform:i}=this.state;const{weightsTexture:s}=this.state;(e=i)===null||e===void 0||e.delete(),i=new Y(o,{id:"".concat(this.id,"-weights-transform"),elementCount:1,_targetTexture:s,_targetTextureVarying:"weightsTexture",...t}),this.setState({weightsTransform:i})}_setupResources(){const{gl:t}=this.context;this._createTextures();const{textureSize:e,weightsTexture:o,maxWeightsTexture:i}=this.state,s=this.getShaders("weights-transform");this._createWeightsTransform(s);const n=this.getShaders("max-weights-transform"),a=new Y(t,{id:"".concat(this.id,"-max-weights-transform"),_sourceTextures:{inTexture:o},_targetTexture:i,_targetTextureVarying:"outTexture",...n,elementCount:e*e});this.setState({weightsTexture:o,maxWeightsTexture:i,maxWeightTransform:a,zoom:null,triPositionBuffer:new $(t,{byteLength:48,accessor:{size:3}}),triTexCoordBuffer:new $(t,{byteLength:48,accessor:{size:2}})})}updateShaders(t){this._createWeightsTransform(t)}_updateMaxWeightValue(){const{maxWeightTransform:t}=this.state;t.run({parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32776}})}_updateBounds(t=!1){const{viewport:e}=this.context,o=[e.unproject([0,0]),e.unproject([e.width,0]),e.unproject([e.width,e.height]),e.unproject([0,e.height])].map(a=>a.map(Math.fround)),i=zt(o),s={visibleWorldBounds:i,viewportCorners:o};let n=!1;if(t||!this.state.worldBounds||!Wt(this.state.worldBounds,i)){const a=this._worldToCommonBounds(i),r=this._commonToWorldBounds(a);this.props.coordinateSystem===j.LNGLAT&&(r[1]=Math.max(r[1],-85.051129),r[3]=Math.min(r[3],85.051129),r[0]=Math.max(r[0],-360),r[2]=Math.min(r[2],360));const d=this._worldToCommonBounds(r);s.worldBounds=r,s.normalizedCommonBounds=d,n=!0}return this.setState(s),n}_updateTextureRenderingBounds(){const{triPositionBuffer:t,triTexCoordBuffer:e,normalizedCommonBounds:o,viewportCorners:i}=this.state,{viewport:s}=this.context;t.subData(tt(i,3));const n=i.map(a=>Pt(s.projectPosition(a),o));e.subData(tt(n,2))}_updateColorTexture(t){const{colorRange:e}=t.props;let{colorTexture:o}=this.state;const i=Ot(e,!1,Uint8Array);o?o.setImageData({data:i,width:e.length}):o=new U(this.context.gl,{data:i,width:e.length,height:1,...G}),this.setState({colorTexture:o})}_updateWeightmap(){const{radiusPixels:t,colorDomain:e,aggregation:o}=this.props,{weightsTransform:i,worldBounds:s,textureSize:n,weightsTexture:a,weightsScale:r}=this.state;this.state.isWeightMapDirty=!1;const d=this._worldToCommonBounds(s,{useLayerCoordinateSystem:!0});if(e&&o==="SUM"){const{viewport:I}=this.context,c=I.distanceScales.metersPerUnit[2]*(d[2]-d[0])/n;this.state.colorDomain=e.map(A=>A*c*r)}else this.state.colorDomain=e||et;const h={radiusPixels:t,commonBounds:d,textureWidth:n,weightsScale:r};i.update({elementCount:this.getNumInstances()}),wt(this.context.gl,{clearColor:[0,0,0,0]},()=>{i.run({uniforms:h,parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32774},clearRenderTarget:!0,attributes:this.getAttributes(),moduleSettings:this.getModuleSettings()})}),this._updateMaxWeightValue(),a.setParameters({10240:9729,10241:9729})}_debouncedUpdateWeightmap(t=!1){let{updateTimer:e}=this.state;const{debounceTimeout:o}=this.props;t?(e=null,this._updateBounds(!0),this._updateTextureRenderingBounds(),this.setState({isWeightMapDirty:!0})):(this.setState({isWeightMapDirty:!1}),clearTimeout(e),e=setTimeout(this._debouncedUpdateWeightmap.bind(this,!0),o)),this.setState({updateTimer:e})}_worldToCommonBounds(t,e={}){const{useLayerCoordinateSystem:o=!1}=e,[i,s,n,a]=t,{viewport:r}=this.context,{textureSize:d}=this.state,{coordinateSystem:h}=this.props,I=o&&(h===j.LNGLAT_OFFSETS||h===j.METER_OFFSETS),c=I?r.projectPosition(this.props.coordinateOrigin):[0,0],A=d*Ht/r.scale;let f,y;return o&&!I?(f=this.projectPosition([i,s,0]),y=this.projectPosition([n,a,0])):(f=r.projectPosition([i,s,0]),y=r.projectPosition([n,a,0])),jt([f[0]-c[0],f[1]-c[1],y[0]-c[0],y[1]-c[1]],A,A)}_commonToWorldBounds(t){const[e,o,i,s]=t,{viewport:n}=this.context,a=n.unprojectPosition([e,o]),r=n.unprojectPosition([i,s]);return a.slice(0,2).concat(r.slice(0,2))}}_(J,"layerName","HeatmapLayer");_(J,"defaultProps",Vt);const Xt={class:"map-card"},Yt={class:"map-card__header"},$t={class:"toggle-group",role:"group","aria-label":"Heatmap pollutant weighting"},qt=["title","onClick"],te={class:"map-frame","aria-label":"Mapbox heatmap of pollution hotspots"},ee={class:"map-legend","aria-hidden":"true"},oe={class:"legend-subtitle"},ie={__name:"MapboxDeckHeatmap",setup(l){V.accessToken="pk.eyJ1IjoianVud2VuMS0yNCIsImEiOiJjbWhhOTB0OXgxaHhoMmxwdWFuajg0dTg4In0._dlzG_ciC_aQKohMPH9MbA";const t=F(null),e=F([]),o=F("pm25"),i=[{id:"pm25",label:"PM₂.₅",description:"Fine particulate matter"},{id:"nox",label:"NOₓ",description:"Nitrogen oxides"},{id:"ozone",label:"O₃",description:"Ground-level ozone"}],s={pm25:3.8,nox:4.6,ozone:4.2},n={pm25:70,nox:55,ozone:48},a={center:[-118.28,34],zoom:9.5},r={pm25:"µg/m³",nox:"ppb",ozone:"ppb"},d=lt(()=>i.find(g=>g.id===o.value)??i[0]),h=g=>{o.value!==g&&(o.value=g,M())},I=()=>{c&&c.easeTo({center:a.center,zoom:a.zoom,bearing:0,pitch:0,duration:1200})};let c,A,f;const y=(g,p,C)=>!Number.isFinite(g)||C===p?0:(g-p)/(C-p),E=async()=>{const g=new URL("/aigc-analytics-dashboard/assets/complaints-C3JJk2yc.csv",import.meta.url),p=new URL("data:application/json;base64,WwogIHsKICAgICJpZCI6ICJBUS0wMSIsCiAgICAibmFtZSI6ICJEb3dudG93biBMQSBTZW5zb3IiLAogICAgImxhdGl0dWRlIjogMzQuMDQwNywKICAgICJsb25naXR1ZGUiOiAtMTE4LjI0NjgsCiAgICAicG0yNSI6IDE4LjYsCiAgICAib3pvbmUiOiAzMiwKICAgICJub3giOiA0MSwKICAgICJodW1pZGl0eSI6IDQ2CiAgfSwKICB7CiAgICAiaWQiOiAiQVEtMDIiLAogICAgIm5hbWUiOiAiU2FudGEgTW9uaWNhIFBpZXIiLAogICAgImxhdGl0dWRlIjogMzQuMDA5NCwKICAgICJsb25naXR1ZGUiOiAtMTE4LjQ5NzMsCiAgICAicG0yNSI6IDExLjIsCiAgICAib3pvbmUiOiAyNCwKICAgICJub3giOiAyMiwKICAgICJodW1pZGl0eSI6IDYxCiAgfSwKICB7CiAgICAiaWQiOiAiQVEtMDMiLAogICAgIm5hbWUiOiAiUGFzYWRlbmEgQ2l2aWMgQ2VudGVyIiwKICAgICJsYXRpdHVkZSI6IDM0LjE0NzgsCiAgICAibG9uZ2l0dWRlIjogLTExOC4xNDQ1LAogICAgInBtMjUiOiAxNC4zLAogICAgIm96b25lIjogMjcsCiAgICAibm94IjogMzMsCiAgICAiaHVtaWRpdHkiOiA0MQogIH0sCiAgewogICAgImlkIjogIkFRLTA0IiwKICAgICJuYW1lIjogIkxvbmcgQmVhY2ggUG9ydCIsCiAgICAibGF0aXR1ZGUiOiAzMy43Njc2LAogICAgImxvbmdpdHVkZSI6IC0xMTguMTk1NywKICAgICJwbTI1IjogMjEuOCwKICAgICJvem9uZSI6IDM4LAogICAgIm5veCI6IDU4LAogICAgImh1bWlkaXR5IjogNjgKICB9LAogIHsKICAgICJpZCI6ICJBUS0wNSIsCiAgICAibmFtZSI6ICJIb2xseXdvb2QgUmVzZXJ2b2lyIiwKICAgICJsYXRpdHVkZSI6IDM0LjEyNDksCiAgICAibG9uZ2l0dWRlIjogLTExOC4zMjQsCiAgICAicG0yNSI6IDEzLjEsCiAgICAib3pvbmUiOiAyOCwKICAgICJub3giOiAyOSwKICAgICJodW1pZGl0eSI6IDUxCiAgfSwKICB7CiAgICAiaWQiOiAiQVEtMDYiLAogICAgIm5hbWUiOiAiSW5nbGV3b29kIFN0YXRpb24iLAogICAgImxhdGl0dWRlIjogMzMuOTYxNywKICAgICJsb25naXR1ZGUiOiAtMTE4LjM1MzEsCiAgICAicG0yNSI6IDE2LjksCiAgICAib3pvbmUiOiAzMSwKICAgICJub3giOiA0NCwKICAgICJodW1pZGl0eSI6IDU3CiAgfSwKICB7CiAgICAiaWQiOiAiQVEtMDciLAogICAgIm5hbWUiOiAiQm95bGUgSGVpZ2h0cyBTdGF0aW9uIiwKICAgICJsYXRpdHVkZSI6IDM0LjAzMzgsCiAgICAibG9uZ2l0dWRlIjogLTExOC4yMTE5LAogICAgInBtMjUiOiAxOS40LAogICAgIm96b25lIjogMzYsCiAgICAibm94IjogNDksCiAgICAiaHVtaWRpdHkiOiA1MgogIH0sCiAgewogICAgImlkIjogIkFRLTA4IiwKICAgICJuYW1lIjogIlZhbiBOdXlzIE1vbml0b3JpbmciLAogICAgImxhdGl0dWRlIjogMzQuMTg5OSwKICAgICJsb25naXR1ZGUiOiAtMTE4LjQ0OTMsCiAgICAicG0yNSI6IDE1LjYsCiAgICAib3pvbmUiOiAyOSwKICAgICJub3giOiAzOCwKICAgICJodW1pZGl0eSI6IDQzCiAgfSwKICB7CiAgICAiaWQiOiAiQVEtMDkiLAogICAgIm5hbWUiOiAiUG9tb25hIEZhaXJwbGV4IiwKICAgICJsYXRpdHVkZSI6IDM0LjA4MjcsCiAgICAibG9uZ2l0dWRlIjogLTExNy43NjUyLAogICAgInBtMjUiOiAyMC44LAogICAgIm96b25lIjogNDEsCiAgICAibm94IjogNTQsCiAgICAiaHVtaWRpdHkiOiA0OAogIH0sCiAgewogICAgImlkIjogIkFRLTEwIiwKICAgICJuYW1lIjogIlRvcnJhbmNlIFJlZmluZXJ5IEJlbHQiLAogICAgImxhdGl0dWRlIjogMzMuODM1LAogICAgImxvbmdpdHVkZSI6IC0xMTguMzEzNywKICAgICJwbTI1IjogMjIuNSwKICAgICJvem9uZSI6IDM0LAogICAgIm5veCI6IDYyLAogICAgImh1bWlkaXR5IjogNjQKICB9LAogIHsKICAgICJpZCI6ICJBUS0xMSIsCiAgICAibmFtZSI6ICJHcmlmZml0aCBPYnNlcnZhdG9yeSBSaWRnZSIsCiAgICAibGF0aXR1ZGUiOiAzNC4xMTg0LAogICAgImxvbmdpdHVkZSI6IC0xMTguMzAwNCwKICAgICJwbTI1IjogMTIuNCwKICAgICJvem9uZSI6IDI2LAogICAgIm5veCI6IDI3LAogICAgImh1bWlkaXR5IjogNDQKICB9LAogIHsKICAgICJpZCI6ICJBUS0xMiIsCiAgICAibmFtZSI6ICJTb3V0aCBHYXRlIENvcnJpZG9yIiwKICAgICJsYXRpdHVkZSI6IDMzLjk0NDMsCiAgICAibG9uZ2l0dWRlIjogLTExOC4xOTI3LAogICAgInBtMjUiOiAxOC4xLAogICAgIm96b25lIjogMzMsCiAgICAibm94IjogNTcsCiAgICAiaHVtaWRpdHkiOiA1OQogIH0KXQo=",import.meta.url),[C,x]=await Promise.all([St(g,u=>{const w=Number.parseFloat(u.latitude),N=Number.parseFloat(u.longitude);return!Number.isFinite(w)||!Number.isFinite(N)?null:{latitude:w,longitude:N,baseWeight:1,source:"Complaint",label:u.category??"Complaint"}}).then(u=>u.filter(Boolean)),fetch(p).then(u=>u.json())]),b=x.map(u=>Number(u.pm25??0)).filter(Number.isFinite),T=x.map(u=>Number(u.nox??u.no2??0)).filter(Number.isFinite),v=x.map(u=>Number(u.ozone??0)).filter(Number.isFinite),z=B(b.length?b:[0,1]),W=B(T.length?T:[0,1]),O=B(v.length?v:[0,1]),L=x.map(u=>{var w,N;return{latitude:Number(u.latitude),longitude:Number(u.longitude),rawPm25:Number(u.pm25??0),rawNox:Number(u.nox??u.no2??0),rawOzone:Number(u.ozone??0),pm25:y(Number(u.pm25??0),z[0],z[1]),nox:y(Number(u.nox??u.no2??0),W[0],W[1]),ozone:y(Number(u.ozone??0),O[0],O[1]),source:"Sensor",label:`${u.name}
PM₂.₅ ${((N=(w=u.pm25)==null?void 0:w.toFixed)==null?void 0:N.call(w,1))??"--"} μg/m³ · NOₓ ${u.nox??"--"} ppb · O₃ ${u.ozone??"--"} ppb`}}).filter(u=>Number.isFinite(u.latitude)&&Number.isFinite(u.longitude));e.value=[...C,...L]},D=g=>{if(g.source==="Complaint")return({pm25:.25,nox:.06,ozone:.08}[o.value]??.2)*(g.baseWeight??1);if(g.source==="Sensor"){const p=o.value;return(g[p]??0)*(s[p]??3.5)}return 0},R=()=>new J({id:"la-air-quality-heatmap",data:e.value,getPosition:g=>[g.longitude,g.latitude],getWeight:g=>D(g),radiusPixels:n[o.value]??55,intensity:1.25,threshold:.08,aggregation:"MEAN",colorRange:[[30,64,175,0],[37,99,235,80],[59,130,246,140],[45,197,116,180],[250,204,21,210],[239,68,68,240]]}),M=()=>{if(!A)return;if(!e.value.length){A.setProps({layers:[]});return}const g={pm25:"PM₂.₅",nox:"NOₓ",ozone:"O₃"}[o.value]??"Pollutant";A.setProps({layers:[R()],getTooltip:({object:p})=>{if(!p)return null;const{position:C,colorValue:x}=p,b=p.points??[],T=b.filter(L=>L.source==="Complaint").length,v=b.filter(L=>L.source==="Sensor"),z=o.value==="pm25"?"rawPm25":o.value==="nox"?"rawNox":"rawOzone",W=r[o.value]??"";let O="No sensor nearby";return v.length&&(O=`Sensor avg: ${(v.reduce((u,w)=>u+(w[z]??0),0)/v.length).toFixed(1)} ${W}`),{text:`${g} hotspot: ${x.toFixed(2)}
${O}
Complaints: ${T||"0"}
Lon ${C[0].toFixed(3)}, Lat ${C[1].toFixed(3)}`}}})},S=()=>{t.value&&(c=new V.Map({container:t.value,style:"mapbox://styles/mapbox/dark-v11",center:a.center,zoom:a.zoom,minZoom:8.4,maxZoom:13.5}),c.on("load",()=>{A=new Mt({layers:[]}),c.addControl(A),M()}))};return Z(e,()=>M(),{deep:!1}),Z(o,()=>M()),ut(async()=>{await E(),S(),M(),t.value&&(f=new ResizeObserver(()=>{c&&c.resize()}),f.observe(t.value))}),gt(()=>{f&&t.value&&f.unobserve(t.value),c&&A&&c.removeControl(A),c&&(c.remove(),c=null)}),(g,p)=>(H(),k("section",Xt,[m("header",Yt,[p[0]||(p[0]=m("div",null,[m("h2",{class:"h5 mb-1"},"Air Quality Hotspots"),m("p",{class:"map-subhead mb-0"}," Deck.GL Heatmap blends 311 environmental complaints with sensor readings to reveal persistent pollution hubs across Los Angeles. Toggle pollutant weightings to interrogate different patterns. ")],-1)),m("div",$t,[(H(),k(ct,null,dt(i,C=>m("button",{key:C.id,type:"button",class:pt(["btn btn-sm",["btn-toggle",C.id===o.value?"btn-primary":"btn-outline-light text-white"]]),title:`切换至 ${C.label} 权重`,onClick:x=>h(C.id)},K(C.label),11,qt)),64))]),m("button",{type:"button",class:"btn btn-sm btn-outline-light text-white reset-view",title:"重置地图视角",onClick:I}," Reset View ")]),m("div",te,[m("div",{ref_key:"mapContainer",ref:t,class:"mapbox-surface"},null,512),m("div",ee,[p[1]||(p[1]=m("p",{class:"legend-title"},"Relative Intensity",-1)),m("p",oe,"Weighting: "+K(d.value.label),1),p[2]||(p[2]=m("div",{class:"gradient-bar"},null,-1)),p[3]||(p[3]=m("div",{class:"legend-scale"},[m("span",null,"lower"),m("span",null,"higher")],-1)),p[4]||(p[4]=m("p",{class:"legend-note"},"Sensors · AQ network 2024 · LA 311 complaints",-1))])])]))}},se=rt(ie,[["__scopeId","data-v-5bd61d95"]]),ne={class:"container"},de={__name:"CityAirHotspotsPage",setup(l){return(t,e)=>(H(),k("div",ne,[e[0]||(e[0]=m("header",{class:"mb-4"},[m("h1",{class:"h3 fw-semibold mb-1"},"Air Pollution Hotspots"),m("p",{class:"text-muted mb-0"}," Heatmap analysis layers 311 complaints with PM₂.₅ sensor readings to spotlight persistent air-quality trouble spots for mitigation planning. ")],-1)),mt(se)]))}};export{de as default};
